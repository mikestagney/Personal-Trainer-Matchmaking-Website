-- Create the TrainerPortal database
DROP DATABASE IF EXISTS trainer_portal;
CREATE DATABASE trainer_portal;
\c trainer_portal

BEGIN TRANSACTION;

CREATE TABLE users
(
    user_id int GENERATED BY DEFAULT AS IDENTITY,
    first_name varchar(25) NOT NULL,
    last_name varchar(25) NOT NULL,
    username varchar(25) NOT NULL UNIQUE,
    password varchar(256) NOT NULL,
    salt varchar(256) NOT NULL,
    role varchar(10) NOT NULL,
    constraint pk_trainer primary key (user_id),
    constraint chk_role CHECK (role IN ('Trainer', 'Client'))
);

CREATE TABLE user_profile
(
    user_id int NOT NULL UNIQUE,
    first_name varchar(25) NOT NULL,
    last_name varchar(25) NOT NULL,
    is_public boolean NOT NULL DEFAULT false,
    role varchar(10) NOT NULL,
    city varchar(30),
    state varchar(2),

    constraint pk_client_profile primary key (user_id)
);

CREATE TABLE trainer_profile
(
    user_id int NOT NULL UNIQUE,
    price_per_hour int,
    rating decimal(3,2),
    philosphy varchar(250),
    bio varchar(1000),
    certifications varchar(250),

    constraint pk_trainer_profile primary key (user_id)
);

CREATE TABLE client_list
(
    trainerId int NOT NULL,
    clientId int NOT NULL,
    privateNotes text ARRAY,

    constraint pk_client_list primary key (trainerId, clientId)
);

CREATE TABLE private_message
(
    trainerId int NOT NULL,
    clientId int NOT NULL,
    postDate timestamp NOT NULL,
    subject varchar(250),
    message varchar(1000),

    constraint pk_private_message primary key (trainerId, clientId, postDate)
);

-- Stored Procedures
CREATE OR REPLACE FUNCTION random_integer(low INT ,high INT)
RETURNS INT AS
$$
BEGIN
    RETURN floor(random()* (high-low + 1) + low);
END;
$$
LANGUAGE 'plpgsql' STRICT;

CREATE OR REPLACE FUNCTION random_boolean()
RETURNS BOOLEAN AS
$$
BEGIN
    IF random() < 0.5 THEN
        RETURN false;
    ELSE
        RETURN true;
    END IF;
END;
$$
LANGUAGE 'plpgsql' STRICT;

CREATE OR REPLACE FUNCTION trainer_search
    (
    t_city           VARCHAR(30)  = NULL,
    t_state          VARCHAR(2)   = NULL,
    t_certifications VARCHAR(250) = NULL,
    t_min_price      INT = 0,
    t_max_price      INT = 2147483647,
    t_rating         INT = 0
    )
 RETURNS TABLE
    (
    user_id         INT
  , is_public       BOOLEAN
  , first_name      VARCHAR
  , last_name       VARCHAR
  , city            VARCHAR
  , state           VARCHAR
  , role            VARCHAR
  , price_per_hour  INT
  , rating          NUMERIC
  , philosphy       VARCHAR
  , bio             VARCHAR
  , certifications  VARCHAR
    ) AS
$$
BEGIN
    RETURN QUERY
    SELECT
        users.user_id
        , true    
        , users.first_name 
        , users.last_name      
        , user_profile.city             
        , user_profile.state            
        , users.role                    
        , trainer_profile.price_per_hour 
        , trainer_profile.rating           
        , trainer_profile.philosphy        
        , trainer_profile.bio              
        , trainer_profile.certifications
    FROM users
    JOIN trainer_profile USING(user_id)
    JOIN user_profile    USING(user_id)
    WHERE user_profile.is_public = true AND
        ($1 IS NULL OR user_profile.city           = $1)    AND
        ($2 IS NULL OR user_profile.state          = $2)    AND
        ($3 IS NULL OR trainer_profile.certifications = $3) AND
        (trainer_profile.price_per_hour BETWEEN $4 AND $5)  AND
        trainer_profile.rating >= $6;
END
$$
LANGUAGE plpgsql;


-- user data
INSERT INTO users (user_id,first_name,last_name,username,password,salt,role) VALUES
 (1,'Waylon','O''Hara','Kari78','pKkjz5CLGGIh4ND','fOzycrWX4cXAGGV','Client')
,(2,'Elise','Mayert','Lewis.Paucek','UAs6zyKsgghmcZw','cmvaE2gYpCkM59d','Client')
,(3,'Zella','Hilpert','Arvel.Ruecker','AjQc1h8S3cPyKTm','zPa43KHWCeNl9yi','Client')
,(4,'Darius','Thompson','Ebba.Mueller47','1RQFACvS2fLeeup','GCXIVxeMYZVfxZn','Client')
,(5,'Cristina','Russel','Bradford.Ziemann','09X7f1tKIgbIND7','rMirr4sFnQ0bkAW','Client')
,(6,'Floy','Shanahan','Daniela_Graham37','ttuMvaHBZ0HWVCX','fPpyI1PLJaFOvSQ','Client')
,(7,'Ellsworth','Rutherford','Maximillian.Schamberger','3aTCI28burpURRh','PfvkPqKIwMN1Wwd','Client')
,(8,'Eloise','Skiles','Catherine.Moore','Skeor05X3nJBcwB','LwkU4KSFfhDRc4E','Client')
,(9,'Wilhelm','Effertz','Skyla_Rowe46','oU_PkXeGP_A4q9x','T_EVPauG96wGJsD','Client')
,(10,'Bridgette','Wisozk','Jerrod55','AidVtlC0bclToof','mM6i_tySQ4xMWe_','Client')
,(11,'Lesley','Harris','Carter29','kkQUtIpwSg6uqQA','vt_ZpYEQ06eZ2KR','Client')
,(12,'Dayna','Rohan','Sheila67','EGli40Llqzw_HE8','fbDL72CvOFoffcF','Client')
,(13,'Morton','Schaefer','Obie_Rath','qW6ZQRlKxFlh7Sx','mg3CjDywPaWJFQ_','Client')
,(14,'Amira','Sawayn','Jenifer.Bernier','MtYx92ZZ7vsodi9','B5EfSZjGr3OKjLX','Client')
,(15,'Gino','Gutmann','Warren79','ICDkwylkzVqI2nx','5DeAEIONGxwVk8e','Client')
,(16,'Reilly','Mayer','Keegan_Maggio','Q3VEYXYJuwt7oWT','44EsZaKbLXv7kIp','Client')
,(17,'Sonny','Mohr','Bernadette_Gorczany','TI4e73cmara8rPb','7E1tC3bFiDkRajp','Client')
,(18,'Hayley','Anderson','Ellis_Brakus','hklek6OycU3upx3','S38vsXgq7IpbLN7','Client')
,(19,'Hailee','Glover','Aida78','9QC6mQdcGruBUOq','nhdMcQNuoH5rRHa','Client')
,(20,'Conner','Abshire','Lessie.McKenzie98','mmBLag7Dt9ovgqb','1i68Ns09XorOkrK','Client')
,(21,'Isaias','Medhurst','Brendon_Hegmann','fDWN7L_aNElDWlB','pcggOUXY36ScmdZ','Client')
,(22,'Christine','Tillman','Unique_Davis','4oBQoYM7mceodjI','kDhbkGpIowia4n9','Client')
,(23,'Dandre','Romaguera','Monserrate.Yost81','d7ZDXioVEs7TsxT','UehUbtLP2dGdzH_','Client')
,(24,'Gayle','Dare','Emerson_Labadie','EtPDoxbFcaQyUZ8','JtfZoOPeo3zWxEP','Client')
,(25,'Ezra','Zemlak','Irving.Pouros','39ZRF8UP0f4iX8E','8Lin5ITYfmWgolI','Client')
,(26,'Maiya','Grady','Leonor.Sawayn38','nCqtVzqSSdq8uhv','G5EDeUR_OyGbMwt','Client')
,(27,'Jonatan','Feeney','Maybelle_Lang92','TUeJ0uWqaTRDi0Z','29JqvAZsSnCbQMI','Client')
,(28,'Jalon','Robel','Felicita1','ExDfSHfnWFxxJuY','PZuWr5xdzq9aoQt','Client')
,(29,'Einar','Herzog','Rusty.Cormier18','8bF1iWNjqJg9ICL','AXbu_Zx26UWc3Rf','Client')
,(30,'Casandra','Reichel','Elisabeth.Auer','oawIZfF9NvJhIGh','agQ9E6kyL1tIMau','Client')
,(31,'first','last','username','password','agQ9E6kyL1tIMau','Client');

-- user_profile
INSERT INTO user_profile (user_id,first_name,last_name,is_public,role,city,state) VALUES
 (1,'Madisen','Schulist','false','Client','South Irwinhaven','CT')
,(2,'Joanny','Hilll','false','Client','Koelpinberg','OH')
,(3,'Ryder','Kreiger','false','Client','South Yvonne','MD')
,(4,'Gladys','Mante','false','Client','Doramouth','OR')
,(5,'Arnaldo','Gottlieb','false','Client','East Carlotta','IN')
,(6,'Margaret','Rippin','false','Client','Orionburgh','DE')
,(7,'Esta','Connelly','false','Client','Langoshmouth','ME')
,(8,'Hope','Lang','false','Client','East Janis','RI')
,(9,'Hilma','Morar','false','Client','Stoltenbergside','WY')
,(10,'Wilburn','Schmitt','false','Client','South Cassidyton','WY')
,(11,'Juana','Stiedemann','false','Client','Swaniawskifurt','PA')
,(12,'Angie','Johns','false','Client','New Braeden','AR')
,(13,'Dameon','Gutmann','false','Client','North Foster','NJ')
,(14,'Maryjane','Cummerata','false','Client','North Naomiemouth','WA')
,(15,'Molly','Collins','false','Client','South Dusty','WA')
,(16,'Glenna','Leuschke','false','Client','East Alysson','NH')
,(17,'Mekhi','Stokes','false','Client','South Sherman','CT')
,(18,'Robyn','Champlin','false','Client','Stantonberg','CT')
,(19,'Layla','VonRueden','false','Client','West Norval','KY')
,(20,'Daron','Watsica','false','Client','New Annetta','IN')
,(21,'Noemi','Leffler','false','Client','McLaughlinbury','OR')
,(22,'Leon','Spinka','false','Client','Kristopherberg','WA')
,(23,'Cooper','Lockman','false','Client','North Mekhi','NC')
,(24,'Emmet','Strosin','false','Client','Melbaport','CT')
,(25,'Donnell','Kirlin','false','Client','South Monroe','OK')
,(26,'Electa','Bergstrom','false','Client','Guillermoton','AR')
,(27,'Retha','Legros','false','Client','Thompsonmouth','SD')
,(28,'Natasha','Ledner','false','Client','South Genevieveton','DE')
,(29,'Sigrid','Batz','false','Client','West Kodymouth','AZ')
,(30,'Brielle','Cruickshank','false','Client','South Karliport','VT')
,(31,'Brielle','Cruickshank','true','Client','South Karliport','VT');


INSERT INTO trainer_profile (user_id,price_per_hour,rating,philosphy,bio,certifications) VALUES
 (1,805.40,1,'We need to quantify the solid state SSL protocol!','Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry''s standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.','IFBB Pro')
,(2,773.36,5,'You can''t back up the firewall without synthesizing the 1080p XSS interface!','Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry''s standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.','IFBB Pro')
,(3,158.47,2,'I''ll calculate the bluetooth AGP transmitter, that should sensor the FTP driver!','Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry''s standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.','IFBB Pro')
,(4,743.06,4,'Try to transmit the IB firewall, maybe it will transmit the primary transmitter!','Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry''s standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.','IFBB Pro')
,(5,354.70,2,'You can''t index the pixel without copying the optical ADP matrix!','Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry''s standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.','IFBB Pro');


-- Updated values
UPDATE user_profile SET is_public = random_boolean();

UPDATE users
SET role = 'Trainer'
WHERE user_id <= 5;

UPDATE user_profile
SET role = 'Trainer'
WHERE user_id <= 5;

-- user_id sequence
select setval('users_user_id_seq', (select max(user_id) from users));

-- Foreign Key Constraints
ALTER TABLE user_profile
ADD FOREIGN KEY(user_id)
REFERENCES users(user_id);

ALTER TABLE trainer_profile
ADD FOREIGN KEY(user_id)
REFERENCES users(user_id);

ALTER TABLE client_list
ADD FOREIGN KEY(trainerId) REFERENCES users(user_id),
ADD FOREIGN KEY(clientId) REFERENCES users(user_id);

ALTER TABLE private_message
ADD FOREIGN KEY(trainerId) REFERENCES users(user_id),
ADD FOREIGN KEY(clientId) REFERENCES users(user_id);

COMMIT TRANSACTION;


